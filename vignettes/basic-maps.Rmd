---
title: "Basic Maps"
author: "Mark Padgham"
date: "`r Sys.Date()`"
output: 
    html_document:
        toc: true
        toc_float: true
        theme: flatly
vignette: >
  %\VignetteIndexEntry{Basic Maps}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


`osmplotr` enables OpenStreetMap (OSM) data to be downloaded (using the
[overpass API](https://overpass-api.de)) and used to produce highly customisable
maps. This vignette demonstrates both data downloading and the creation of
simple maps. The subsequent vignette ('data-maps') demonstrates how
`osmplotr` enables user-defined data to be visualised using OSM data.  The maps
in this vignette represent a small portion of central London, U.K. 


## Contents

[1. Introduction](#1 intro)

[2. Downloading Data](#2 downloading)

[&nbsp;&nbsp;&nbsp;&nbsp;2.1 Negation](#2.1 negation)

[&nbsp;&nbsp;&nbsp;&nbsp;2.2 Additional `key-value` pairs](#2.2 keyval-pairs)

[&nbsp;&nbsp;&nbsp;&nbsp;2.3 A note on rivers](#2.3 rivers)

[&nbsp;&nbsp;&nbsp;&nbsp;2.4 Downloading with `osm_structures` and `make_osm_map`](#2.4 downloading2)

[&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2.4.1 The `london` data of `osmplotr`](#2.4.1 london-data)

[&nbsp;&nbsp;&nbsp;&nbsp;2.5 Downloading connected highways](#2.5 highways)

[&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2.5.1 `connect_highways` in detail](#2.5.1 highways-detail)

[3. Producing maps](#3 maps)

[&nbsp;&nbsp;&nbsp;&nbsp;3.1 Saving Maps](#3.1 saving-maps)

[&nbsp;&nbsp;&nbsp;&nbsp;3.2 Plotting different OSM Structures](#3.2 osm-structures)

[&nbsp;&nbsp;&nbsp;&nbsp;3.3. Automating map production](#3.3 make-osm-map)

[&nbsp;&nbsp;&nbsp;&nbsp;3.4 Axes](#3.4 axes)


## <a name="1 intro"></a>1. Introduction

A map can be generated using the following simple steps:
```{r, echo = FALSE, message = FALSE}
#library (osmplotr)
#devtools::install_github ("ropensci/osmplotr")
devtools::load_all ("../.", export_all = FALSE)
library (maptools) # Needed for this vignette
```

```{r, echo = FALSE, message = FALSE}
# Combining (dat_B, dat_BC) and (dat_H, dat_HP) requires removing the repeated
# objects
indx <- which (!london$dat_BR$id %in% london$dat_BNR$id)
dat_B <- maptools::spRbind (london$dat_BR [indx, ], london$dat_BNR)
indx <- which (!london$dat_H$id %in% london$dat_HP$id)
dat_H <- maptools::spRbind (london$dat_H [indx, ], london$dat_HP)
dat_T <- london$dat_T
```
1. Specify the bounding box for the desired region
```{r}
bbox <- get_bbox (c(-0.13, 51.50, -0.11, 51.52))
```
2. Download the desired data---in this case, all building perimeters.
```{r, eval = FALSE}
dat_B <- extract_osm_objects (key = 'building', bbox = bbox)
```
3. Initiate an `osm_basemap` with desired background (`bg`) colour
```{r map1}
map <- osm_basemap (bbox = bbox, bg = 'gray20')
```
4. Add desired plotting objects in the desired colour.
```{r}
map <- add_osm_objects (map, dat_B, col = 'gray40')
```
5. Print the map
```{r, eval = FALSE}
print_osm_map (map)
```
```{r map1-print, echo = FALSE}
print_osm_map (map, filename = 'map_a1.png', width = 600,
               units = 'px', dpi = 72)
```
![](map_a1.png)

The function `print_osm_map` creates a graphics device that is scaled to the
bounding box of the map.  Note also that `osmplotr` maps contain no margins and
fill the entire plot area.  Additional capabilities of `osmplotr` are described
in the following sections, beginning with downloading and extraction of data.

## <a name="2 downloading"></a>2. Downloading Data

The main function for downloading OSM data from the 
[overpass API](https://overpass-api.de) is `extract_osm_objects`. Data of a
particular type can be extracted by passing the appropriate OSM `key`, as in the
above example:
```{r buildings-highways, eval = FALSE}
bbox <- get_bbox (c(-0.13, 51.51, -0.11, 51.52))
dat_B <- extract_osm_objects (key = 'building', bbox = bbox)
dat_H <- extract_osm_objects (key = 'highway', bbox = bbox)
```
These objects are of appropriate `Spatial` classes:
```{r}
class (dat_B); class (dat_H)
```
The `SpatialPolygonsDataFrame` and `SpatialLinesDataFrame`
of London buildings and highways respectively
contain 
```{r}
length (dat_B); length (dat_H)
```
... 2,178 building polygons and 2,139 highway lines.  `extract_osm_objects` also
accepts `key-value` pairs which are passed to the
[overpass API](https://overpass-api.de) :
```{r trees, eval = FALSE}
dat_T <- extract_osm_objects (key = 'natural', value = 'tree', bbox = bbox)
```
Trees are located by single coordinates and are thus `SpatialPoints`:
```{r}
class (dat_T); length (dat_T)
```

## <a name="2.1 negation"></a>2.1 Negation

Negation can be specified by pre-pending `!` to the `value` argument so that,
for example, all `natural` objects that are **not** trees can be extracted with
```{r not trees, eval = FALSE}
dat_NT <- extract_osm_objects (bbox = bbox, key = 'natural', value = '!tree')
```
```{r, echo = FALSE}
message ("Cannot determine return type; maybe specify explicitly?")
```
The message is generated because of course a request for anything that is not a
tree could be for any kind of spatial object. `osmplotr` makes several educated
guesses in the absence of specified return types, but these can always be forced
with the `return_type` parameter:
```{r not tree points, eval = FALSE}
pts_NT <- extract_osm_objects (bbox = bbox, key = 'natural', value = '!tree',
                               return_type = 'points')
```

`london$dat_H` contains all non-primary highways, and was extracted with,
```{r non-primary highways, eval = FALSE}
dat_H <- extract_osm_objects (key = 'highway', value = '!primary', bbox = bbox)
```
In this case, a request for `key = 'highway'` automatically returns line objects
(although, again, other kinds of objects may be forced through specifying
`return_type`).

## <a name="2.2 keyval-pairs"></a>2.2 Additional `key-value` pairs

Any number of `key-value` pairs may be passed to `extract_osm_objects`. For
example, a named building can be extracted with
```{r royal festival hall, eval = FALSE}
bbox <- get_bbox (c(-0.13, 51.50, -0.11, 51.52))
extra_pairs <- c ('name', 'Royal.Festival.Hall')
dat <- extract_osm_objects (key = 'building', extra_pairs = extra_pairs,
                                       bbox = bbox)
```
This data is stored in `london$dat_RFH`. Note that periods or dots are used for
whitespace, and in fact symbolise (in `grep` terms) any character whatsoever.
The polygon of a building at a particular street address can be extracted with
```{r stamford st 150, eval = FALSE}
extra_pairs <- list (c ('addr:street', 'Stamford.St'),
                     c ('addr:housenumber', '150'))
dat <- extract_osm_objects (key = 'building', extra_pairs = extra_pairs,
                                      bbox = bbox)
```
This data is stored as `london$dat_ST`.  Note that addresses generally require
combining both `addr:street` with `addr:housenumber`.


## <a name="2.4 downloading2"></a>2.4 Downloading with `osm_structures` and `make_osm_map`

The functions `osm_structures` and `make_osm_map` aid both downloading multiple
OSM data types and plotting (with the latter described below).  `osm_structures`
returns a `data.frame` of OSM structure types, associated `key-value` pairs,
unique suffices which may be appended to data structures for storage purposes,
and suggested colours. Passing this list to `make_osm_map` will return a list of
the requested OSM data items, named through combining the `dat_prefix` specified
in `make_osm_map` and the suffices specified in `osm_structures`.

```{r}
osm_structures ()
```
Many structures are identified by keys only, in which cases the values are empty
strings.
```{r}
osm_structures()$value [1:4]
```
The last row of `osm_structures` exists only to define the background colour of
the map, as explained below 
([3.3. Automating map production](#3.3 make-osm-map)).

The suffices include as many letters as are necessary to represent all unique
structure names.  `make_osm_map` returns a list of two components:

1. `osm_data` containing the data objects passed in the `osm_structures`
   argument. Any existing `osm_data` may also be submitted to `make_osm_map`, in
   which case any objects not present in the submitted data will be
   appended to the returned version. If `osm_data` is not submitted, all objects in
   `osm_structures` will be downloaded and returned.
2. `map` containing the `ggplot2` map objects with layers overlaid according to
   the sequence and colour schemes specified in `osm_structures`

The data specified in `osm_structures` can then be downloaded simply by calling:
```{r, eval = FALSE}
dat <- make_osm_map (structures = osm_structures (), bbox = bbox)
```
```{r, echo = FALSE}
dat1 <- list (dat_BU = NULL, dat_A = NULL, dat_W = NULL, dat_G = NULL,
              dat_N = NULL, dat_P = NULL, dat_H = NULL, dat_BO = NULL,
              dat_T = NULL)
dat <- list (osm_data = dat1, map = ggplot2::ggplot ())
```
```{r}
names (dat); sapply (dat, class); names (dat$osm_data)
```
The requested data are contained in `dat$osm_data`.  A list of desired structures
can also be passed to this function, for example,
```{r}
osm_structures (structures = c('building', 'highway'))
```
Passing this to `make_osm_map` will download only these two structures.
Finally, note that the example of,
```{r}
osm_structures (structures = 'grass')
```
demonstrates that `osm_structures` converts a number of common `keys` to
OSM-appropriate `key-value` pairs.

### <a name="2.4.1 london-data"></a>2.4.1 The `london` data of `osmplotr`

To illustrate the use of `osm_structures` to download data, this section
reproduces the code that was used to generate the `london` data object which
forms part of the `osmplotr` package.
```{r}
structures <- c ('highway', 'highway', 'building', 'building', 'building',
                 'amenity', 'park', 'natural', 'tree')
structs <- osm_structures (structures = structures, col_scheme = 'dark')
structs$value [1] <- '!primary'
structs$value [2] <- 'primary'
structs$suffix [2] <- 'HP'
structs$value [3] <- '!residential'
structs$value [4] <- 'residential'
structs$value [5] <- 'commercial'
structs$suffix [3] <- 'BNR'
structs$suffix [4] <- 'BR'
structs$suffix [5] <- 'BC'
```
Suffices are generated automatically from structure names only, not values, and
the suffices for negated forms must therefore be specified manually.  The
`london` data can then be downloaded by simply calling `make_osm_map`:
```{r, eval = FALSE}
london <- make_osm_map (structures = structs, bbox = bbox)
london <- london$osm_data
```
The requested data are contained in the `$osm_data` list item. `make_osm_map`
also returns a `$map` item which is described below 
(see [3.3. Automating map production](#3.3 make-osm-map)).

## <a name="2.5 highways"></a>2.5 Downloading connected highways

The visualisation functions described in the second `osmplotr` vignette
([Data maps](https://cran.r-project.org/package=osmplotr))
enable particular regions of maps
to be highlighted. While it may often be desirable to highlight regions
according to a user's own data, `osmplotr` also enables regions to be defined by
providing a list of the names of encircling highways. The function which
achieves this is `connect_highways`, which returns a sequential list of
`SpatialPoints` from those segments of the named highways which connected
continuously and sequentially to form a single enclosed space. An example is,
```{r, echo = FALSE}
highways1 <- london$highways1
```
```{r, eval = FALSE}
highways <- c ('Monmouth.St', 'Short.?s.Gardens', 'Endell.St', 'Long.Acre',
               'Upper.Saint.Martin')
highways1 <- connect_highways (highways = highways, bbox = bbox)
```
Note the use of the [regex](https://en.wikipedia.org/wiki/Regular_expression)
character `?` which declares that the previous character is optional. This
matches both "Shorts Gardens" and "Short's Gardens", both of which appear in OSM
data.
```{r}
class (highways1); length (highways1); head (coordinates (highways1))
```
Other examples, which are also included in the provided `london` data, include:
```{r, eval = FALSE}
highways <- c ('Endell.St', 'High.Holborn', 'Drury.Lane', 'Long.Acre')
highways2 <- connect_highways (highways = highways, bbox = bbox)
highways <- c ('Drury.Lane', 'High.Holborn', 'Kingsway', 'Great.Queen.St')
highways3 <- connect_highways (highways = highways, bbox = bbox)
```

The extraction of bounding polygons from named highways is not failsafe, and may
generate various warning messages.  To understand the kinds of conditions under
which it may not work, it is useful to examine `connect_highways` in more
detail.

### <a name="2.5.1 highways-detail"></a>2.5.1 `connect_highways` in detail

`connect_highways` takes a list of OpenStreetMap highways and sequentially
connects closest nodes of adjacent highways until the set of named highways
connects to form a cycle.  Cases where no circular connection is possible
generate an error message. The routine proceeds through the three stages of,

1. Adding intersection nodes to junctions of ways where these don't already
   exist

2. Filling a connectivity matrix between the listed highways and extracting the
   **longest** cycle connecting all of them 

3. Inserting extra connections between highways until the length of the longest
   cycle is equal to `length (highways)`.

However, even once the highways are connected, the individual components of each
highway may not necessarily connect in a continuous manner to complete the
cycle. The final task is thus ensuring that the components of each individual
highway actually connect, through sequentially connecting the closest pairs of
components until a shortest path is possible between the two components which
connect with other highways.

This procedure can not be guaranteed failsafe owing both to the inherently
unpredictable nature of OpenStreetMap, as well as to the unknown relationships
between named highways. To enable problematic cases to be examined and hopefully
resolved, `connect_highways` has a `plot` option:
```{r connect_highways, fig.width = 4, message = FALSE, eval = FALSE}
bbox_big <- get_bbox (c(-0.15, 51.5, -0.10, 51.52))
highways <- c ('Kingsway', 'Holborn', 'Farringdon.St', 'Strand',
               'Fleet.St', 'Aldwych')
highway_list <- connect_highways (highways = highways, bbox = bbox_big,
                                  plot = TRUE)
```
```{r, eval = FALSE}
## Warning message:
## In get_highway_cycles(ways) : Cycle unable to be extended through all ways
```
```{r highway-coordindates, echo = FALSE}
# The above lines can not be run because the httr calls can not be guaranteed to
# always work, which may break the package. The raw data are thus manually
# reconstructed here, as #  returned from the `extract_highways` call at the
# start # of `connect_highways`.

# -----  ways#1 = kingsway = "ki"
w1 <- list ()
x <- c (-0.1203338, -0.1202834, -0.1200126, -0.1198595, -0.1197361, -0.1197068,
        -0.1195780, -0.1195262, -0.1194575, -0.1190897, -0.1189450, -0.1185311,
        -0.1181623, -0.1180223, -0.1179162, -0.1176477, -0.1175738, -0.1175508,
        -0.1175232, -0.1174684, -0.1174248, -0.1173510, -0.1172695, -0.1171477)
y <- c (51.51763, 51.51752, 51.51707, 51.51685, 51.51667, 51.51662, 51.51645,
        51.51638, 51.51627, 51.51572, 51.51549, 51.51490, 51.51435, 51.51414,
        51.51399, 51.51361, 51.51347, 51.51342, 51.51338, 51.51333, 51.51331,
        51.51329, 51.51327, 51.51326)
w1 [[1]] <- cbind (x, y)
  
x <- c (-0.1177822, -0.1183894, -0.1186147, -0.1189761, -0.1187049, -0.1186499,
        -0.1186063, -0.1178860, -0.1176837, -0.1176697, -0.1176985, -0.1177276,
        -0.1178918, -0.1179792)
y <- c (51.51362, 51.51453, 51.51487, 51.51529, 51.51489, 51.51479, 51.51472,
        51.51363, 51.51333, 51.51326, 51.51320, 51.51317, 51.51306, 51.51300)
w1 [[2]] <- cbind (x, y)

x <- c (-0.1207126, -0.1209534, -0.1209650, -0.1209782, -0.1210017)
y <- c (51.51832, 51.51885, 51.51887, 51.51890, 51.51894)
w1 [[3]] <- cbind (x, y)

x <- c (-0.1189761, -0.1192240, -0.1195124, -0.1196821, -0.1197235, -0.1198689,
        -0.1201884, -0.1203754, -0.1204008, -0.1204221, -0.1204581)
y <- c (51.51529, 51.51566, 51.51608, 51.51635, 51.51641, 51.51663, 51.51711,
        51.51740, 51.51745, 51.51750, 51.51761)
w1 [[4]] <- cbind (x, y)

# -----  ways#2 = holborn = "ho"
w2 <- list ()
x <- c (-0.1073888, -0.1074540, -0.1075185, -0.1076360, -0.1077478, -0.1078570,
        -0.1079144, -0.1079830, -0.1086946, -0.1089403, -0.1091716, -0.1094742,
        -0.1098301, -0.1099699, -0.1103197, -0.1106341, -0.1110240, -0.1111562,
        -0.1113596, -0.1115494, -0.1117466, -0.1122220, -0.1123933, -0.1126314,
        -0.1129071, -0.1134849, -0.1135798, -0.1138032, -0.1139495, -0.1140080,
        -0.1147225, -0.1150249, -0.1151676, -0.1154342, -0.1157788, -0.1159226,
        -0.1164696, -0.1174284, -0.1177863, -0.1182263, -0.1184347, -0.1185711,
        -0.1186829, -0.1189389, -0.1191618, -0.1193111, -0.1196010, -0.1199908,
        -0.1200612, -0.1201523, -0.1203338, -0.1204581, -0.1205869, -0.1212578,
        -0.1216958, -0.1217600, -0.1218442, -0.1219475, -0.1224044, -0.1225913,
        -0.1227188, -0.1228778, -0.1228405, -0.1228247, -0.1228225, -0.1228279,
        -0.1228362, -0.1228491, -0.1228730)
y <- c (51.51792, 51.51789, 51.51786, 51.51779, 51.51779, 51.51780, 51.51781,
        51.51782, 51.51790, 51.51793, 51.51796, 51.51799, 51.51803, 51.51805,
        51.51810, 51.51813, 51.51819, 51.51819, 51.51817, 51.51819, 51.51821,
        51.51825, 51.51826, 51.51828, 51.51828, 51.51827, 51.51827, 51.51826,
        51.51824, 51.51824, 51.51818, 51.51815, 51.51813, 51.51811, 51.51807,
        51.51805, 51.51798, 51.51786, 51.51782, 51.51777, 51.51775, 51.51772,
        51.51770, 51.51768, 51.51767, 51.51769, 51.51768, 51.51767, 51.51766,
        51.51765, 51.51763, 51.51761, 51.51759, 51.51748, 51.51742, 51.51741,
        51.51739, 51.51738, 51.51729, 51.51723, 51.51718, 51.51709, 51.51713,
        51.51716, 51.51719, 51.51722, 51.51724, 51.51726, 51.51727)
w2 [[1]] <- cbind (x, y)

x <- c (-0.1078570, -0.1078050, -0.1077439, -0.1077216, -0.1076941, -0.1076781,
        -0.1076690, -0.1076687, -0.1076360, -0.1076254, -0.1076132, -0.1075956,
        -0.1075671, -0.1073964, -0.1072101, -0.1071337, -0.1070688, -0.1066737,
        -0.1064886, -0.1063870, -0.1060042, -0.1057503, -0.1055184, -0.1054163,
        -0.1052826, -0.1051399, -0.1049645, -0.1047192, -0.1045709, -0.1039530,
        -0.1037755, -0.1034216, -0.1032032, -0.1030749, -0.1029335, -0.1030199,
        -0.1032675, -0.1041485, -0.1041978, -0.1043540, -0.1046169, -0.1046618,
        -0.1047714, -0.1050268, -0.1050061, -0.1046876, -0.1046172, -0.1045350,
        -0.1044643, -0.1043342, -0.1042645, -0.1041994)
y <- c (51.51780, 51.51781, 51.51782, 51.51782, 51.51784, 51.51786, 51.51788,
        51.51790, 51.51779, 51.51775, 51.51773, 51.51771, 51.51769, 51.51768,
        51.51767, 51.51767, 51.51766, 51.51765, 51.51763, 51.51761, 51.51752,
        51.51745, 51.51737, 51.51734, 51.51729, 51.51725, 51.51716, 51.51708,
        51.51703, 51.51685, 51.51680, 51.51670, 51.51664, 51.51660, 51.51658,
        51.51663, 51.51672, 51.51700, 51.51703, 51.51707, 51.51715, 51.51716,
        51.51716, 51.51719, 51.51723, 51.51713, 51.51711, 51.51708, 51.51705,
        51.51701, 51.51700, 51.51699)
w2 [[2]] <- cbind (x, y)

x <- c (-0.1228778, -0.1234916, -0.1235685, -0.1243109, -0.1243585, -0.1244536,
        -0.1245306, -0.1246545, -0.1254008, -0.1259866, -0.1262079, -0.1265772,
        -0.1266956)
y <- c (51.51709, 51.51677, 51.51673, 51.51635, 51.51632, 51.51627, 51.51624,
        51.51619, 51.51597, 51.51583, 51.51571, 51.51562, 51.51560)
w2 [[3]] <- cbind (x, y)

x <- c (-0.1172287, -0.1174284)
y <- c (51.51748, 51.51786)
w2 [[4]] <- cbind (x, y)

x <- c (-0.1066737, -0.1069975, -0.1070762, -0.1071923, -0.1072383, -0.1072770,
        -0.1073044, -0.1073270, -0.1073363, -0.1073313, -0.1073104, -0.1074463,
        -0.1075671, -0.1077508, -0.1079733, -0.1078033, -0.1078412, -0.1078397,
        -0.1078511, -0.1078757, -0.1079191, -0.1080370, -0.1087398, -0.1089713,
        -0.1098844, -0.1103362, -0.1106012, -0.1110572, -0.1111793, -0.1113596)
y <- c (51.51765, 51.51771, 51.51772, 51.51774, 51.51775, 51.51776, 51.51778,
        51.51780, 51.51783, 51.51785, 51.51788, 51.51778, 51.51769, 51.51770,
        51.51773, 51.51764, 51.51759, 51.51762, 51.51765, 51.51768, 51.51770,
        51.51773, 51.51780, 51.51783, 51.51793, 51.51800, 51.51804, 51.51810,
        51.51813, 51.51817)
w2 [[5]] <- cbind (x, y)

x <- c (-0.1075671, -0.1076405, -0.1077281)
y <- c (51.51769, 51.51763, 51.51756)
w2 [[6]] <- cbind (x, y)

x <- c (-0.1077508, -0.1077133, -0.1076360, -0.1075296, -0.1074463, -0.1071923)
y <- c (51.51770, 51.51773, 51.51779, 51.51779, 51.51778, 51.51774)
w2 [[7]] <- cbind (x, y)

x <- c (-0.1029335, -0.1028356, -0.1022412, -0.1021218, -0.1020550, -0.1019383)
y <- c (51.51658, 51.51654, 51.51636, 51.51632, 51.51629, 51.51623)
w2 [[8]] <- cbind (x, y)

x <- c (-0.1259866, -0.1262434, -0.1266495)
y <- c (51.51583, 51.51577, 51.51569)
w2 [[9]] <- cbind (x, y)

# -----  ways#3 = farringdon = "fa"
w3 <- list ()
x <- c (-0.1053307, -0.1053222, -0.1051554, -0.1051337, -0.1050048, -0.1050268,
        -0.1049810, -0.1049714, -0.1048933, -0.1048360, -0.1048029, -0.1047782,
        -0.1047473, -0.1047210, -0.1047070, -0.1046885, -0.1046733, -0.1045898,
        -0.1044599, -0.1044126, -0.1044076, -0.1043972, -0.1043866)
y <- c (51.51853, 51.51839, 51.51773, 51.51765, 51.51709, 51.51719, 51.51697,
        51.51691, 51.51662, 51.51639, 51.51619, 51.51609, 51.51599, 51.51590,
        51.51585, 51.51578, 51.51569, 51.51523, 51.51464, 51.51435, 51.51431,
        51.51423, 51.51416)
w3 [[1]] <- cbind (x, y)


# -----  ways#4 = Strand = "st"
w4 <- list ()
x <- c (-0.1148455, -0.1147169, -0.1143319, -0.1142481, -0.1141126, -0.1138229,
        -0.1131541, -0.1129196, -0.1126044, -0.1129479, -0.1130797, -0.1132352,
        -0.1133298, -0.1135138, -0.1136998, -0.1139613, -0.1143011, -0.1143485,
        -0.1144666, -0.1145398, -0.1146810, -0.1150460, -0.1154463, -0.1159902,
        -0.1164315, -0.1166843, -0.1168605, -0.1169288, -0.1170255, -0.1171296,
        -0.1172043, -0.1172841, -0.1174156, -0.1175801, -0.1176979, -0.1182491,
        -0.1184023, -0.1184755, -0.1186610, -0.1185853, -0.1178146, -0.1184697,
        -0.1185693, -0.1186913, -0.1188589, -0.1189134, -0.1189739, -0.1190246,
        -0.1190439, -0.1190493)
y <- c (51.51310, 51.51311, 51.51319, 51.51321, 51.51324, 51.51329, 51.51342,
        51.51346, 51.51350, 51.51337, 51.51331, 51.51324, 51.51312, 51.51299,
        51.51292, 51.51290, 51.51283, 51.51282, 51.51279, 51.51277, 51.51274,
        51.51266, 51.51262, 51.51248, 51.51237, 51.51235, 51.51233, 51.51232,
        51.51230, 51.51224, 51.51220, 51.51214, 51.51206, 51.51198, 51.51194,
        51.51174, 51.51167, 51.51164, 51.51153, 51.51155, 51.51179, 51.51156,
        51.51152, 51.51147, 51.51140, 51.51138, 51.51135, 51.51131, 51.51127,
        51.51126)
w4 [[1]] <- cbind (x, y)

x <- c (-0.1186610, -0.1187229, -0.1188932, -0.1189579, -0.1189981, -0.1190156,
        -0.1190878, -0.1191024, -0.1191218, -0.1191734, -0.1192331, -0.1193068,
        -0.1193927, -0.1197643, -0.1203253, -0.1205753, -0.1209497, -0.1210485,
        -0.1213673, -0.1214427, -0.1219553, -0.1225706, -0.1229996, -0.1231092,
        -0.1233414, -0.1239622, -0.1240154, -0.1244558, -0.1249539, -0.1250239,
        -0.1252361, -0.1254117, -0.1255360, -0.1256501, -0.1257753, -0.1261925,
        -0.1263742, -0.1265227, -0.1267240, -0.1268331, -0.1269508, -0.1270393,
        -0.1271114, -0.1271606, -0.1272088, -0.1272879)
y <- c (51.51153, 51.51151, 51.51145, 51.51144, 51.51141, 51.51140, 51.51136,
        51.51135, 51.51134, 51.51130, 51.51126, 51.51122, 51.51118, 51.51105,
        51.51085, 51.51076, 51.51061, 51.51058, 51.51045, 51.51042, 51.51021,
        51.50996, 51.50977, 51.50972, 51.50961, 51.50930, 51.50928, 51.50905,
        51.50881, 51.50877, 51.50865, 51.50855, 51.50849, 51.50843, 51.50836,
        51.50813, 51.50805, 51.50797, 51.50786, 51.50780, 51.50773, 51.50766,
        51.50760, 51.50755, 51.50751, 51.50745)
w4 [[2]] <- cbind (x, y)

x <- c (-0.1273590, -0.1272069, -0.1271056, -0.1270122, -0.1268913, -0.1264592,
        -0.1261746, -0.1259023, -0.1258526, -0.1257237, -0.1255779, -0.1254902,
        -0.1254481, -0.1253909, -0.1253286, -0.1251370, -0.1250935, -0.1246758,
        -0.1241422, -0.1240796, -0.1239434, -0.1234040, -0.1231415, -0.1230134,
        -0.1226558, -0.1225264, -0.1221580, -0.1219193, -0.1217775, -0.1215778,
        -0.1215106, -0.1211855, -0.1211063, -0.1205906, -0.1201147, -0.1195975,
        -0.1194596, -0.1193430, -0.1192777, -0.1192312, -0.1192182, -0.1191734)
y <- c (51.50768, 51.50772, 51.50776, 51.50780, 51.50786, 51.50809, 51.50824,
        51.50839, 51.50842, 51.50849, 51.50858, 51.50863, 51.50865, 51.50868,
        51.50871, 51.50881, 51.50883, 51.50904, 51.50930, 51.50933, 51.50940,
        51.50967, 51.50979, 51.50985, 51.51001, 51.51006, 51.51022, 51.51032,
        51.51038, 51.51045, 51.51048, 51.51061, 51.51064, 51.51083, 51.51101,
        51.51120, 51.51126, 51.51129, 51.51130, 51.51130, 51.51130, 51.51130)
w4 [[3]] <- cbind (x, y)

x <- c (-0.1173477, -0.1175145, -0.1176001, -0.1177008, -0.1182013, -0.1183661,
        -0.1188020, -0.1190861, -0.1191253, -0.1191024, -0.1191067, -0.1189679,
        -0.1188802, -0.1188057, -0.1186803, -0.1185429, -0.1183372, -0.1180943,
        -0.1177803, -0.1176436, -0.1176048, -0.1175963, -0.1175641, -0.1175711,
        -0.1176225, -0.1177822)
y <- c (51.50901, 51.50925, 51.50937, 51.50948, 51.51004, 51.51025, 51.51079,
        51.51111, 51.51121, 51.51135, 51.51134, 51.51165, 51.51206, 51.51226,
        51.51242, 51.51257, 51.51274, 51.51289, 51.51302, 51.51309, 51.51313,
        51.51313, 51.51319, 51.51328, 51.51338, 51.51362)
w4 [[4]] <- cbind (x, y)

x <- c (-0.1150460, -0.1154135, -0.1157494, -0.1159890, -0.1164972, -0.1168548,
        -0.1170831, -0.1173289, -0.1175801, -0.1177450, -0.1178146)
y <- c (51.51266, 51.51255, 51.51244, 51.51235, 51.51215, 51.51203, 51.51197,
        51.51191, 51.51185, 51.51181, 51.51179)
w4 [[5]] <- cbind (x, y)

x <- c (-0.1152509, -0.1158511)
y <- c (51.51094, 51.51178)
w4 [[6]] <- cbind (x, y)

x <- c (-0.1119679, -0.1123696, -0.1124974, -0.1126044)
y <- c (51.51366, 51.51356, 51.51353, 51.51350)
w4 [[7]] <- cbind (x, y)

x <- c (-0.1194596, -0.1192255)
y <- c (51.51126, 51.51136)
w4 [[8]] <- cbind (x, y)

# -----  ways#5 = fleet street = "fl"
w5 <- list ()
x <- c (-0.1043866, -0.1044715, -0.1045575, -0.1045784, -0.1049186, -0.1050393,
        -0.1051935, -0.1054879, -0.1057340, -0.1059116, -0.1061412, -0.1062298,
        -0.1066312, -0.1066656, -0.1069351, -0.1069496, -0.1070293, -0.1071218,
        -0.1072542, -0.1074023, -0.1074202, -0.1074571, -0.1077385, -0.1079542,
        -0.1081931, -0.1083970, -0.1084777, -0.1085296, -0.1087037, -0.1088420,
        -0.1091747, -0.1092965, -0.1094183, -0.1096951, -0.1103892, -0.1104507,
        -0.1109479, -0.1110552, -0.1112565, -0.1115362, -0.1115864, -0.1116247,
        -0.1118127, -0.111967)
y <- c (51.51416, 51.51416, 51.51416, 51.51416, 51.51416, 51.51416, 51.51417,
        51.51417, 51.51417, 51.51417, 51.51418, 51.51417, 51.51419, 51.51419,
        51.51420, 51.51420, 51.51420, 51.51420, 51.51421, 51.51420, 51.51420,
        51.51420, 51.51420, 51.51419, 51.51419, 51.51418, 51.51418, 51.51417,
        51.51417, 51.51416, 51.51414, 51.51413, 51.51412, 51.51406, 51.51391,
        51.51390, 51.51383, 51.51382, 51.51378, 51.51374, 51.51373, 51.51372,
        51.51369, 51.51366)
w5 [[1]] <- cbind (x, y)

# -----  ways#6 = aldwych = "al"
w6 <- list ()
x <- c (-0.1192255, -0.1191930, -0.1191523, -0.1191138, -0.1190736, -0.1190490,
        -0.1189980, -0.1189772, -0.1189505, -0.1188958, -0.1188187, -0.1187414,
        -0.1187192, -0.1185681, -0.1184583, -0.1183857, -0.1181008, -0.1179792,
        -0.1175934, -0.1176048, -0.1174964, -0.1171477, -0.1169498, -0.1166529,
        -0.1163592, -0.1161216, -0.1160301, -0.1156703, -0.1149205, -0.1148455,
        -0.1147384, -0.1145953, -0.1145420, -0.1145134, -0.1144666)
y <- c (51.51136, 51.51139, 51.51142, 51.51145, 51.51151, 51.51155, 51.51182,
        51.51192, 51.51205, 51.51220, 51.51234, 51.51244, 51.51246, 51.51262,
        51.51272, 51.51278, 51.51294, 51.51300, 51.51313, 51.51313, 51.51316,
        51.51326, 51.51327, 51.51329, 51.51330, 51.51329, 51.51328, 51.51322,
        51.51310, 51.51310, 51.51304, 51.51290, 51.51286, 51.51284, 51.51279)
w6 [[1]] <- cbind (x, y)

ways <- list (w1, w2, w3, w4, w5, w6)


# ----- The perimeter
 
x <- c (-0.1050268, -0.1047714, -0.1046618, -0.1046169, -0.1043540, -0.1041978,
        -0.1041485, -0.1032675, -0.1030199, -0.1029335, -0.1030749, -0.1032032,
        -0.1034216, -0.1037755, -0.1039530, -0.1045709, -0.1047192, -0.1049645,
        -0.1051399, -0.1052826, -0.1054163, -0.1055184, -0.1057503, -0.1060042,
        -0.1063870, -0.1064886, -0.1066737, -0.1074463, -0.1075296, -0.1078570,
        -0.1079144, -0.1079830, -0.1086946, -0.1089403, -0.1091716, -0.1094742,
        -0.1098301, -0.1099699, -0.1103197, -0.1106341, -0.1110240, -0.1111562,
        -0.1113596, -0.1115494, -0.1117466, -0.1122220, -0.1123933, -0.1126314,
        -0.1129071, -0.1134849, -0.1135798, -0.1138032, -0.1139495, -0.1140080,
        -0.1147225, -0.1150249, -0.1151676, -0.1154342, -0.1157788, -0.1159226,
        -0.1164696, -0.1174284, -0.1177863, -0.1182263, -0.1184347, -0.1185711,
        -0.1186829, -0.1189389, -0.1191618, -0.1193111, -0.1196010, -0.1199908,
        -0.1200612, -0.1201523, -0.1203338, -0.1204581, -0.1204581, -0.1204221,
        -0.1204008, -0.1203754, -0.1201884, -0.1198689, -0.1197235, -0.1196821,
        -0.1195124, -0.1192240, -0.1189761, -0.1186147, -0.1183894, -0.1177822,
        -0.1177822, -0.1176225, -0.1175711, -0.1175641, -0.1175963, -0.1176436,
        -0.1177803, -0.1180943, -0.1183372, -0.1185429, -0.1186803, -0.1188057,
        -0.1188802, -0.1189679, -0.1191067, -0.1191024, -0.1190878, -0.1190156,
        -0.1189981, -0.1189579, -0.1188932, -0.1187229, -0.1186610, -0.1185853,
        -0.1178146, -0.1177450, -0.1175801, -0.1173289, -0.1170831, -0.1168548,
        -0.1164972, -0.1159890, -0.1157494, -0.1154135, -0.1150460, -0.1146810,
        -0.1145398, -0.1144666, -0.1143485, -0.1143011, -0.1139613, -0.1136998,
        -0.1135138, -0.1133298, -0.1132352, -0.1130797, -0.1129479, -0.1126044,
        -0.1124974, -0.1123696, -0.1119679, -0.1119679, -0.1118127, -0.1116247,
        -0.1115864, -0.1115362, -0.1112565, -0.1110552, -0.1109479, -0.1104507,
        -0.1103892, -0.1096951, -0.1094183, -0.1092965, -0.1091747, -0.1088420,
        -0.1087037, -0.1085296, -0.1084777, -0.1083970, -0.1081931, -0.1079542,
        -0.1077385, -0.1074571, -0.1074202, -0.1074023, -0.1072542, -0.1071218,
        -0.1070293, -0.1069496, -0.1069351, -0.1066656, -0.1066312, -0.1062298,
        -0.1061412, -0.1059116, -0.1057340, -0.1054879, -0.1051935, -0.1050393,
        -0.1049186, -0.1045784, -0.1045575, -0.1044715, -0.1043866, -0.1043866,
        -0.1043972, -0.1044076, -0.1044126, -0.1044599, -0.1045898, -0.1046733,
        -0.1046885, -0.1047070, -0.1047210, -0.1047473, -0.1047782, -0.1048029,
        -0.1048360, -0.1048933, -0.1049714, -0.1049810)
y <- c (51.51719, 51.51716, 51.51716, 51.51715, 51.51707, 51.51703, 51.51700,
        51.51672, 51.51663, 51.51658, 51.51660, 51.51664, 51.51670, 51.51680,
        51.51685, 51.51703, 51.51708, 51.51716, 51.51725, 51.51729, 51.51734,
        51.51737, 51.51745, 51.51752, 51.51761, 51.51763, 51.51765, 51.51778,
        51.51779, 51.51780, 51.51781, 51.51782, 51.51790, 51.51793, 51.51796,
        51.51799, 51.51803, 51.51805, 51.51810, 51.51813, 51.51819, 51.51819,
        51.51817, 51.51819, 51.51821, 51.51825, 51.51826, 51.51828, 51.51828,
        51.51827, 51.51827, 51.51826, 51.51824, 51.51824, 51.51818, 51.51815,
        51.51813, 51.51811, 51.51807, 51.51805, 51.51798, 51.51786, 51.51782,
        51.51777, 51.51775, 51.51772, 51.51770, 51.51768, 51.51767, 51.51769,
        51.51768, 51.51767, 51.51766, 51.51765, 51.51763, 51.51761, 51.51761,
        51.51750, 51.51745, 51.51740, 51.51711, 51.51663, 51.51641, 51.51635,
        51.51608, 51.51566, 51.51529, 51.51487, 51.51453, 51.51362, 51.51362,
        51.51338, 51.51328, 51.51319, 51.51313, 51.51309, 51.51302, 51.51289,
        51.51274, 51.51257, 51.51242, 51.51226, 51.51206, 51.51165, 51.51134,
        51.51135, 51.51136, 51.51140, 51.51141, 51.51144, 51.51145, 51.51151,
        51.51153, 51.51155, 51.51179, 51.51181, 51.51185, 51.51191, 51.51197,
        51.51203, 51.51215, 51.51235, 51.51244, 51.51255, 51.51266, 51.51274,
        51.51277, 51.51279, 51.51282, 51.51283, 51.51290, 51.51292, 51.51299,
        51.51312, 51.51324, 51.51331, 51.51337, 51.51350, 51.51353, 51.51356,
        51.51366, 51.51366, 51.51369, 51.51372, 51.51373, 51.51374, 51.51378,
        51.51382, 51.51383, 51.51390, 51.51391, 51.51406, 51.51412, 51.51413,
        51.51414, 51.51416, 51.51417, 51.51417, 51.51418, 51.51418, 51.51419,
        51.51419, 51.51420, 51.51420, 51.51420, 51.51420, 51.51421, 51.51420,
        51.51420, 51.51420, 51.51420, 51.51419, 51.51419, 51.51417, 51.51418,
        51.51417, 51.51417, 51.51417, 51.51417, 51.51416, 51.51416, 51.51416,
        51.51416, 51.51416, 51.51416, 51.51416, 51.51423, 51.51431, 51.51435,
        51.51464, 51.51523, 51.51569, 51.51578, 51.51585, 51.51590, 51.51599,
        51.51609, 51.51619, 51.51639, 51.51662, 51.51691, 51.51697)
xy <- cbind (x, y)
```
```{r connect-highways-manual-plot, fig.width = 4, echo = FALSE}
# Then the plot routines copied from connect_highways
xlims <- range (sapply (ways, function (i)
                    range (sapply (i, function (j) range (j [, 1])))))
ylims <- range (sapply (ways, function (i)
                    range (sapply (i, function (j) range (j [, 2])))))
#plot.new ()
par (mar = rep (0, 4))
plot (NULL, NULL, xlim = xlims, ylim = ylims, xaxt = 'n', yaxt = 'n',
      xlab = '', ylab = '', frame = FALSE)
cols <- rainbow (length (ways))
for (i in seq (ways))
    for (j in seq (ways [[i]]))
    {
        x <- ways [[i]] [[j]] [, 1]
        y <- ways [[i]] [[j]] [, 2]
        n <- length (x)
        lines (x, y, col = cols [i])
        text (x [1], y [1], labels = paste0 (i, '.', j), col = cols [i])
        text (x [n], y [n], labels = paste0 (i, '.', j), col = cols [i])
    }
lines (xy [, 1], xy [, 2], lwd = 3, col = 'black', lty = 2)
```

The plot depicts each highway in a different colour, along with numbers at start
and end points of each segment. This plot reveals in this case that highway#6
('Aldwych') is actually nested within two components of highway#4 ('Strand').
`connect_highways` searches for the shortest path connecting all named highways,
and since 'Strand' connects to both highways#1 and #5, the shortest path
excludes #6. This exclusion of one of the named components generates the
warning message. 


## <a name="3 maps"></a>3. Producing maps

Maps will generally contain multiple kinds of OSM data, for example,
```{r, eval = FALSE}
dat_B <- extract_osm_objects (key = 'building', bbox = bbox)
dat_H <- extract_osm_objects (key = 'highway', bbox = bbox)
dat_T <- extract_osm_objects (key = 'natural', value = 'tree', bbox = bbox)
```

As illustrated above, plotting maps requires first making a basemap with a
specified background colour. Portions of maps can also be plotted by creating a
`basemap` with a smaller bounding box.
```{r map2}
bbox_small <- get_bbox (c(-0.13, 51.51, -0.11, 51.52))
map <- osm_basemap (bbox = bbox_small, bg = 'gray20')
map <- add_osm_objects (map, dat_H, col = 'gray70')
map <- add_osm_objects (map, dat_B, col = 'gray40')
```
`map` is then a `ggplot2` which may be viewed simply by passing it to
`print_osm_map`:
```{r, eval = FALSE}
print_osm_map (map)
```
```{r map2-print, echo = FALSE}
print_osm_map (map, filename = 'map_a2.png', width = 600,
               units = 'px', dpi = 72)
```
![](map_a2.png)


Other graphical parameters can also be passed to `add_osm_objects`, such as
border colours or line widths and types. For example,
```{r map3, eval = FALSE}
map <- osm_basemap (bbox = bbox_small, bg = 'gray20')
map <- add_osm_objects (map, dat_B, col = 'gray40', border = 'orange',
                        size = 0.2)
print_osm_map (map)
```
```{r map3-print, echo = FALSE}
map <- osm_basemap (bbox = bbox_small, bg = 'gray20')
map <- add_osm_objects (map, dat_B, col = 'gray40', border = 'orange',
                        size = 0.2)
print_osm_map (map, filename = 'map_a3.png', width = 600,
               units = 'px', dpi = 72)
```
![](map_a3.png)

The `size` argument is passed to the corresponding `ggplot2` routine for
plotting polygons, lines, or points, and respectively determines widths of lines
(for polygon outlines and for lines), and sizes of points.  The `col` argument
determines the fill colour of polygons, or the colour of lines or points.

```{r map4, eval = FALSE}
map <- add_osm_objects (map, dat_H, col = 'gray70', size = 0.7)
map <- add_osm_objects (map, dat_T, col = 'green', size = 2, shape = 1)
print_osm_map (map)
```
```{r map4-print, echo = FALSE}
map <- add_osm_objects (map, dat_H, col = 'gray70', size = 0.7)
map <- add_osm_objects (map, dat_T, col = 'green', size = 2, shape = 1)
print_osm_map (map, filename = 'map_a4.png', width = 600,
               units = 'px', dpi = 72)
```
![](map_a4.png)

Note also that the `shape` parameter determines the point shape, for details of
which see `?ggplot2::shape`. Also note that plot order affects the final
outcome, because components are sequentially overlaid and thus the same map
components plotted in a different order will generally produce a different
result.

## <a name="3.1 saving-maps"></a>3.1 Saving Maps

The function `print_osm_map()` can be used to print either to on-screen
graphical devices or to graphics files (see, for example, `?png` for a list of
possible graphics devices). Sizes and resolutions of devices may be
specified with the appropriate parameters. Device dimensions are scaled by
default to the proportions of the bounding box (although this can be
over-ridden).

A screen-based device simply requires
```{r, eval = FALSE}
print_osm_map (map)
```
while examples of writing higher resolution versions to files include:
```{r, eval = FALSE}
print_osm_map (map, filename = "map.png", width = 10, units = "in", dpi = 72)
print_osm_map (map, filename = "map.eps", width = 1000, units = "px", dpi = 72)
print_osm_map (map, filename = "map", device = "jpeg", width = 10, units = "cm")
```

## <a name="3.2 osm-structures"></a>3.2 Plotting different OSM Structures

The ability demonstrated above to use negation in `extract-osm-objects` allows
different kinds of the same object to be visually contrasted, for example
primary and non-primary highways:

```{r, eval = FALSE}
dat_HP <- extract_osm_objects (key = 'highway', value = 'primary', bbox = bbox)
dat_H <- extract_osm_objects (key = 'highway', value = '!primary', bbox = bbox)
```
```{r, echo = FALSE}
dat_HP <- london$dat_HP
dat_H <- london$dat_H
```
```{r map5, eval = FALSE}
map <- osm_basemap (bbox = bbox_small, bg = 'gray20')
map <- add_osm_objects (map, dat_H, col = 'gray50')
map <- add_osm_objects (map, dat_HP, col = 'gray80', size = 2)
print_osm_map (map)
```
```{r map5-print, echo = FALSE}
map <- osm_basemap (bbox = bbox_small, bg = 'gray20')
map <- add_osm_objects (map, dat_H, col = 'gray50')
map <- add_osm_objects (map, dat_HP, col = 'gray80', size = 2)
print_osm_map (map, filename = 'map_a5.png', width = 600,
               units = 'px', dpi = 72)
```
![](map_a5.png)

The additional `key-value` pairs demonstrated above (for Royal Festival Hall,
`dat_RFH` and 150 Stamford Street, `dat_ST`) also demonstrated above allow for
highly customised maps in which distinct objects are plotting with different
colour schemes.
```{r, echo = FALSE}
dat_RFH <- london$dat_RFH
dat_ST <- london$dat_ST
```
```{r map7, eval = FALSE}
bbox_small2 <- get_bbox (c (-0.118, 51.504, -0.110, 51.507))
map <- osm_basemap (bbox = bbox_small2, bg = 'gray95')
map <- add_osm_objects (map, dat_H, col = 'gray80')
map <- add_osm_objects (map, dat_HP, col = 'gray60', size = 2)
map <- add_osm_objects (map, dat_RFH, col = 'orange', border = 'red', size = 2)
map <- add_osm_objects (map, dat_ST, col = 'skyblue', border = 'blue', size = 2)
print_osm_map (map)
```
```{r map7-print, echo = FALSE}
bbox_small2 <- get_bbox (c (-0.118, 51.504, -0.110, 51.507))
map <- osm_basemap (bbox = bbox_small2, bg = 'gray95')
map <- add_osm_objects (map, dat_H, col = 'gray80')
map <- add_osm_objects (map, dat_HP, col = 'gray60', size = 2)
map <- add_osm_objects (map, dat_RFH, col = 'orange', border = 'red', size = 2)
map <- add_osm_objects (map, dat_ST, col = 'skyblue', border = 'blue', size = 2)
print_osm_map (map, filename = 'map_a7.png', width = 600,
               units = 'px', dpi = 72)
```
![](map_a7.png)


## <a name="3.3 make-osm-map"></a>3.3. Automating map production

As indicated above 
([2.4 Downloading with `osm_structures` and `make_osm_map`](#2.4 downloading2)),
the production of maps overlaying various type of OSM objects is facilitated
with `make_osm_map`.  The structure of a map is defined by `osm_structures` as
described above.

Producing a map with customised data is as simple as,
```{r map8, eval = FALSE}
structs <- c ('highway', 'building', 'park', 'grass', 'tree')
structures <- osm_structures (structures = structs, col_scheme = 'light')
dat <- make_osm_map (structures = structures, bbox = bbox_small)
map <- dat$map
print_osm_map (map)
```
```{r, echo = FALSE}
structs <- c ('highway', 'building', 'park', 'grass', 'tree')
structures <- osm_structures (structures = structs, col_scheme = 'light')
osm_dat <- list (dat_B = dat_B, dat_H = dat_H, dat_P = london$dat_P,
                 dat_A = london$dat_A, dat_G = london$dat_G,
                 dat_T = london$dat_T)
dat <- make_osm_map (structures = structures, osm_data = osm_dat,
                     bbox = bbox_small)
print_osm_map (dat$map, filename = 'map_a8.png', width = 600,
               units = 'px', dpi = 72)
```
![](map_a8.png)

Calling `make_osm_map()` downloads the requested structures within the given
`bbox` and returns a list of two components, the first of which contains the
downloaded data:
```{r}
names (dat); names (dat$osm_data)
```

Pre-downloaded data may also be passed to `make_osm_map()`
```{r map9, eval = FALSE}
dat <- make_osm_map (structures = structures, osm_data = dat$osm_data)
print_osm_map (dat$map)
```
```{r map9-print, echo = FALSE}
dat <- make_osm_map (structures = structures, osm_data = osm_dat)
print_osm_map (dat$map, filename = 'map_a9.png', width = 600,
               units = 'px', dpi = 72)
```
![](map_a9.png)

In this case, because no bounding box was passed to `make_osm_map`, a bounding
box is extracted as the **largest** box spanning all objects in `osm_data`.
These objects include highways which extend beyond the defining bounding box,
and the large park in the south east. The `bbox` argument may simply be passed
to restore this map to the previous version:
```{r map9b, eval = FALSE}
dat <- make_osm_map (structures = structures, osm_data = dat$osm_data,
                     bbox = bbox_small)
```

Objects in maps are overlaid on the plot according to the order of rows in
`osm_structures`, with the single exception that `background` is plotted first.
This order can be readily changed or restricted simply by submitting structures
in a desired order.

```{r}
structs <- c ('amenity', 'building', 'grass', 'highway', 'park')
osm_structures (structs, col_scheme = 'light')
```


## <a name="3.4 axes"></a>3.4 Axes

Axes may be added to maps using the `add_axes` function. In contrast to many `R`
packages for producing maps, maps in `osmplotr` fill the entire plotting space,
and axes are added *internal* to this space. The separate function for adding
axes allows them to be overlaid on top of all previous layers.

Axes added to a dark version of the previous map look like this:
```{r map10}
structures <- osm_structures (structures = structs, col_scheme = 'dark')
dat <- make_osm_map (structures = structures, osm_data = dat$osm_dat,
                     bbox = bbox_small)
map <- add_axes (dat$map, colour = 'black')
```
Note that, as described above, `make_osm_map` returns a list of two items: (i)
potentially modified data (in `$osm_data`) and (ii) the map object (in `$map`).
All other `add_` functions take a map object as one argument and return the
single value of the modified map object.
```{r, eval = FALSE}
print_osm_map (map)
```
```{r map10-print, echo = FALSE}
print_osm_map (map, filename = 'map_a10.png', width = 600,
               units = 'px', dpi = 72)
```
![](map_a10.png)

This map reveals that the axes and labels are printed above semi-transparent
background rectangles, with transparency controlled by the `alpha` parameter.
Axes are always plotted on the left and lower side, but positions can be
adjusted with the `pos` parameter which specifies the,

> Positions of axes and labels relative to entire plot device

```{r map11, eval = FALSE}
map <- add_axes (map, colour = 'blue', pos = c(0.1, 0.2),
                      fontsize = 5, fontface = 3, fontfamily = "Times")
print_osm_map (map)
```
```{r map11-print, echo = FALSE}
map <- add_axes (map, colour = 'blue', pos = c(0.1, 0.2),
                      fontsize = 5, fontface = 3, fontfamily = "Times")
print_osm_map (map, filename = 'map_a11.png', width = 600,
               units = 'px', dpi = 72)
```
![](map_a11.png)

The second call to `add_axes` overlaid additional axes on a map that already had
axes from the previous call.  This call also demonstrates how sizes and other
font characteristics of text labels can be specified.  

Finally, the current version of `osmplotr` does not allow text labels of axes to
be rotated. (This is because the semi-transparent underlays are generated with
`ggplot2::geom_label` which currently prevents rotation.)

Click on the following link to proceed to the second `osmplotr` vignette:
[Data maps](https://cran.r-project.org/package=osmplotr)
